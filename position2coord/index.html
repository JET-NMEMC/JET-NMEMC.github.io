<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv='X-UA-Compatible' content='IE=Edge'>
  <link href='lib/mapbox.js/latest/mapbox.css' rel='stylesheet' />
  <link rel='stylesheet' href='css/font-awesome/css/font-awesome.min.css'>
  <link rel='stylesheet' href='css/fonts/mplus.css'>
  <title>GeoJSON转SHP</title>
  <link href='lib/draw/leaflet.draw.css' rel='stylesheet' />
  <link href='lib/codemirror/lib/codemirror.css' rel='stylesheet' />
  <link href='css/base.css' rel='stylesheet' />
  <link href='css/marker.css' rel='stylesheet' />
  <link href='css/github_browse.css' rel='stylesheet' />
  <link href='css/site.css' rel='stylesheet' />
  <link href='css/my.css' rel='stylesheet' />
  <link href='css/theme.css' rel='stylesheet' />
  <link rel='icon' type='image/x-icon' href='/img/favicon.png' />
  <meta name='author' content='MapBox' />
  <meta name='description' content='simply edit geojson map data' />
  <meta property='og:site_name' content='geojson.io' />
  <meta name='viewport' content='initial-scale=1,maximum-scale=1'>

  <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  <script src='lib/mapbox.js/latest/mapbox.js'></script>
  <script src='lib/raven.min.js'></script>
  <script type="text/javascript"
    src="http://api.tianditu.gov.cn/api?v=4.0&tk=0a5d3fb2ad894a60ff2d3abccc7a7c51"></script>
  <meta http-equiv="Content-Security-Policy" content="
    default-src
      'self'
      ;
    child-src
      'self'
      blob:
      ;
    connect-src
      'self'
      *
      ;
    font-src
      'self'
      ;
    frame-src
      'self'
      ;
    img-src
      'self'
      data:
      *
      ;
    script-src
      'self'
      'unsafe-eval'
      'unsafe-inline'
      https://cdn.segment.com
      https://assets.customer.io
      https://secure.gaug.es
      https://www.google-analytics.com
      ;
    style-src
      'self'
      'unsafe-inline'
      ;
  ">
  <script>
    if (/a\.tiles\.mapbox\.com/.test(L.mapbox.config.HTTP_URL)) {
      Raven.config('https://c2d096c944dd4150ab7e44b0881b4a46@app.getsentry.com/11480', {
        whitelistUrls: [/geojson\.io/],
        ignoreErrors: [
          'Uncaught Error: Error connecting to extension ckibcdccnfeookdmbahgiakhnjcddpki',
          'Uncaught Error: Error connecting to extension pioclpoplcdbaefihamjohnefbikjilc'
        ]
      }).install();
    }
  </script>
  <style>
    body {
      display: none;
    }
  </style>
</head>

<body id='geojsonio-body'>

  <div class='geojsonio'></div>
  <button id="ht1" class="ht1" onclick=getlocation2()>get location</button>
  <textarea id="textarea" class="textarea" cols="40" rows="20">经度	纬度	name	省份&#10;121.561	38.875	大连市	辽宁省&#10;120.427	36.093	青岛市	山东省
  </textarea>
  <textarea id="textarea2" class="textarea2" cols="10" rows="10"></textarea>
  <script>
    if (self == top) {
      document.getElementsByTagName("body")[0].style.display = 'block';
    } else {
      top.location = self.location;
    }
  </script>

  <script src='dist/delegate.js'></script>
  <script src='dist/lib.js'></script>
  <script src='dist/site.js'></script>
  <!-- <script src='dist/shpwrite.js'></script> -->
  <script src='dist/mapshaper.js'></script>
  <script src="dist/GeoShape.js"></script>
  <script src="dist/jszip.min.js"></script>


  <script type='text/javascript' charset="UTF-8">
    var position;
    var coord;
    var coord0 = new Array;
    // var vectormap = L.featureGroup();
    var mymap = window.api.map;

    function getlocation() {
      // vectormap.clearLayers();
      window.api.mapLayer.clearLayers()
      var Utext = document.getElementById("textarea").value;
      Utext = Utext.trim();
      Utext = Utext.replace(/'/g, "′");
      var yyy = Utext.split(/[\n]/); //按行分割
      console.log(yyy);
      // console.log(window.api)

      for (i = 0; i < yyy.length; i++) {
        position = yyy[i];
        getad(position);
        // console.log(aaa)
        // console.log(coord);
        coord0[i] = coord;
        var lng = coord.location.lon;
        var lat = coord.location.lat;
        console.log(lng, lat)
        // L.marker([lat, lng])
        L.marker([lat, lng])
          // L.Draw.Marker([lat, lng])
          .bindPopup(position).openPopup()
          .addTo(window.api.mapLayer);


        // vectormap.addTo(window.api.map);
        // vectormap.addTo(window.api.mapLayer)
      }
      // console.log(mymap);
      // mymap.setView([30,120],8);
      console.log(window.api.mapLayer);
      // mymap.fitBounds(vectormap.getBounds());
      mymap.fitBounds(window.api.mapLayer.getBounds());
    }

    function getad(position) {

      var url0 = 'https://api.tianditu.gov.cn/geocoder?ds={"keyWord":"' + position + '"}&tk=0a5d3fb2ad894a60ff2d3abccc7a7c51';
      var url = 'https://api.tianditu.gov.cn/apiserver/ajaxproxy?proxyReqUrl=' + url0;
      $.ajax({
        url: url,
        async: false,
        // dataType: 'JSON',
        type: "get",
        success: function (result2) {
          var str = result2.slice(19);
          var str2 = str.slice(0, str.length - 1);
          coord = JSON.parse(str2);
          console.log("coord");
          console.log(coord);
        }
      });
      // console.log(json)
    }

    function getlocation2() {
      var Utext = document.getElementById("textarea").value;
      Utext = Utext.trim();
      Utext = Utext.replace(/'/g, "′");
      var yyy = Utext.split(/[\n]/); //按行分割
      console.log("行数", yyy.length);
      var liename = yyy[0].split(/,|，|\s+/);
      console.log("列名", liename);

      var featuresAll = [];
      var range=[];
      range[0] = -180;
      range[1] = 180;
      range[2] = -90;
      range[3] = 90;

      for (var j = 1; j < yyy.length; j++) {
        var point1 = yyy[j].split(/,|，|\s+/);
        var coord = [Number(point1[0]), Number(point1[1])];
        console.log(coord);
        
        if (point1[0] > range[0]) { range[0] = point1[0] };
        if (point1[0] < range[1]) { range[1] = point1[0] };
        if (point1[1] > range[2]) { range[2] = point1[1] };
        if (point1[1] < range[3]) { range[3] = point1[1] };

        //重组属性prop，赋给properties
        var prop = {};
        for (var i = 2; i < liename.length; i++) {
          eval("prop." + liename[i] + "='" + point1[i] + "'")
        }

        //生成单个形状的json
        var featurej = lineString(coord, prop);
        // console.log(featurej);
        // console.log(JSON.stringify(featurej))
        featuresAll.push(featurej);
      }
      console.log(range);

      var featuresFinal = featureCollection(featuresAll);
      console.log(featuresFinal);
      var expJson = JSON.stringify(featuresFinal)
      console.log(expJson);
      document.getElementById("textarea2").value = expJson;
      document.querySelector("#textarea2").select();
      document.execCommand('copy');


      var options = {
        folder: 'myshapes',
        types: {
          point: 'mypoints',
          polygon: 'mypolygons',
          line: 'mylines'
        }
      }

      // var sdf = importGeoJSON(featuresFinal);
      // consolelog(sdf)
      // a GeoJSON bridge for features
      // shpwrite.download(featuresFinal, options);



      GeoShape.transformAndDownload(featuresFinal);


      // var abc = document.getElementsByTagName("div")
      // for (var i = 0; i < abc.length; i++) {
      //   if (abc[i].className = "CodeMirror-code") {
      //     console.log(abc[i]);
      //   // abc[i].innerHTML =""
      //   }
      // }


      //     alert("YES");
      //     // abc[i].innerhtml = JSON.stringify(featuresFinal) 
      //     abc[i].innerHTML = 'QQQQQQQQQQQQQQQQQQQQ'
      //     // abc[i].innerHTML = '<div style="position:relative;"> <div style="position:absolute;left:-29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"style="left:0px;width:20px;">1</div></div><pre>' + expJson + '</pre></div>'
      //   }
      // }


      // var abd = document.getElementsByTagName("pre");
      // console.log(abd);
      // for (var i = abd.length - 1; i > 0; i--) {
      //   // abd[i].innerText = ""
      //   // console.log(abd[i].)
      //   console.log(abd[i].parentElement)

      //   // abd[i].innerText = ""
      // }
      // abd[1].innerHTML = expJson

    }


    function featureCollection(features, option) {
      var fc = { type: "FeatureCollection" };
      fc.features = features;
      return fc;
    }

    function lineString(coordinates, properties, options) {
      return feature(
        {
          type: "Point",
          coordinates: coordinates
        },
        properties,
        options
      )
    }

    function feature(geometry, properties, options) {
      var feat = { type: "Feature" };
      feat.properties = properties || {};
      feat.geometry = geometry;
      return feat;
    }

  </script>
</body>

</html>