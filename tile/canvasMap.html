<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CanvasMap</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <!-- <link rel="icon" type="image/png" href="splitearth_v12b.png"> -->
    <script src="https://cdn.bootcss.com/FileSaver.js/1.3.8/FileSaver.min.js"></script>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/gdal3.js@2.1.0/dist/package/gdal3.js"
        integrity="sha384-r9LuL3uWvWB90NwulendmLxfI6CPFkDSUiZ2qiUK7qCPhbK+JIQOD/pKp7NO+5Ys"
        crossorigin="anonymous"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.min.js"></script>
    <script src="canvastotiff.js"></script>
    <script src="main.min.js"></script>
</head>

<!-- <body onload="app.main()"> -->

<body>
    <div id="completion"></div>
    <button id="up">Up</button>
    <button id="down">Down</button>
    <button id="left">Left</button>
    <button id="right">Right</button>
    <button id="zoomIn">Zoom In</button>
    <button id="zoomOut">Zoom Out</button>
    <input type="number" name="" value="1" id="number" style="width: 50px;" onchange="change()">
    <button onclick="chushihua()">初始化</button>
    <button onclick="print()">打印</button>
    <button onclick="download(canvas)">下载</button>
    <p></p>
    <div class="canvasLayers">
        <canvas id="rasterCanvas"></canvas>
        <canvas id="vectorCanvas"></canvas>
    </div>
    <a href=""></a>
    <div id="coordinates"></div>
    <p>
        Enter longitude and latitude in degrees for a bounding box:<br>
        <input type="text" id="west" placeholder="West Longitude" value="121">
        <input type="text" id="east" placeholder="East Longitude" value="123">
        <input type="text" id="north" placeholder="North Latitude" value="40">
        <input type="text" id="south" placeholder="South Latitude" value="38.6">
        <button id="bboxSet">Set Bounding Box</button>
        <input class="input-file" type="file" name="file" id="file" onChange="onFileChange" />

    </p>
    <script>
        function change() {
            var mapclass = document.getElementById("number").value
            console.log(mapclass)
        //     // params.zoom = mapclass
        //     params.width = params.width * mapclass
        //     params.height = params.height * mapclass
        //     // var app = {}
        //     app.main()
        }
        function chushihua() {
            var mapclass = document.getElementById("number").value
            params.width = 256 * 4 * mapclass
            params.height = 256 * 3 * mapclass
            app.main()
        }
        
        var canvas = document.getElementById("rasterCanvas");
        // canvas.addEventListener()

        // Covert to TIFF using Object-URL (faster, smaller size)
        // CanvasToTIFF.toObjectURL(canvas, function (url) {
        //     var a = document.querySelector("a");
        //     a.href = url;
        //     a.innerHTML = "Right-click this link, select Save As to save the TIFF";
        // })


        // initGdalJs({ path: 'https://cdn.jsdelivr.net/npm/gdal3.js@2.1.0/dist/package', useWorker: false }).then((Gdal) => { });
        // // JS
        // var readimage
        // function onFileChange({ target }) {
        //     readimage = Gdal.open(target.file);
        // }
        // function onFileChange({ target }) {
        //     async function test(target) {
        //         const Gdal = await initGdalJs();
        //         const result = await Gdal.open(target.file).datasets[0];
        //         const options = [
        //             '-of', 'tiff',
        //             '-t_srs', 'EPSG:4857'
        //         ];
        //         const filePath = await Gdal.gdalwarp(dataset, options);
        //         console.log(result, filePath)
        //     }
        //     test(target)
        // }

        // async function test() {
        //     const Gdal = await initGdalJs();
        //     const dataset = (await Gdal.open('./image.tiff')).datasets[0];
        //     const options = [
        //         '-of', 'tiff',
        //         '-t_srs', 'EPSG:4857'
        //     ];
        //     const filePath = await Gdal.gdalwarp(dataset, options);
        // }
        // test()

        function print() {
            console.log(app.params)
            var minX = tile2long(app.params.xTile0, app.params.zoom)
            var maxX = tile2long(app.params.xTile1, app.params.zoom)
            var minY = tile2lat(app.params.yTile1, app.params.zoom)
            var maxY = tile2lat(app.params.yTile0, app.params.zoom)

            var numX = app.params.width
            var numY = app.params.height

            console.log("经度范围", minX, maxX);
            console.log("纬度范围", minY, maxY);

            var D = 0, B = 0
            // var A = (maxX - minX) / numX //X方向上的象素分辨率
            // var E = (minY - maxY) / numY
            var C = proj4('EPSG:4326', 'EPSG:3857').forward([minX, maxY])[0]
            var F = proj4('EPSG:4326', 'EPSG:3857').forward([minX, maxY])[1]
            var CR = proj4('EPSG:4326', 'EPSG:3857').forward([maxX, minY])[0]
            var FR = proj4('EPSG:4326', 'EPSG:3857').forward([maxX, minY])[1]
            var A = (CR - C) / numX //X方向上的象素分辨率
            var E = (FR - F) / numY

            console.log(A, D, B, E, C, F)
        }




        function download(canvas) {

            // canvas.toBlob(function (blob) {
            //     saveAs(blob, 'image')
            // });

            CanvasToTIFF.toBlob(canvas, function (blob) {
                // blob object can be converted to an objectURL and then
                // set as source for images, or as download target:
                var url = URL.createObjectURL(blob);
                // console.log(url)
                saveAs(blob, 'image')
            });
        }

        function tile2long(x, z) {
            return (x / Math.pow(2, z) * 360 - 180);
        }
        function tile2lat(y, z) {
            var n = Math.PI - 2 * Math.PI * y / Math.pow(2, z);
            return (180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n))));
        }


        // console.log('EPSG:4326', proj4.defs('EPSG:4326'))
        // console.log('EPSG:3857', proj4.defs('EPSG:3857'))
        // console.log(proj4('EPSG:4326', 'EPSG:3857').forward([120, 39]));
        // console.log(lonlattoWebMercator(120, 39))

        // function lonlattoWebMercator(lon, lat) {
        //     var xy = [];
        //     var x = lon * 20037508.3428 / 180;
        //     var y = Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180);
        //     y = y * 20037508.3428 / 180;
        //     xy[0] = x;
        //     xy[1] = y;
        //     return (xy);
        // }


    </script>

</body>

</html>